<article id="doc-architecture" class="doc-content" data-lang="zh">
    <h1>工作原理（高级）</h1>
    <p>下面两张图展示复盘镜在本机如何运行，以及"证据 → 工作片段（会话） → 回顾/技能"的口径链路。</p>

    <h2>运行时组件图</h2>
    <figure>
        <svg viewBox="0 0 900 360" width="100%" role="img" aria-label="复盘镜（WorkMirror）运行时组件图">
            <rect x="20" y="20" width="520" height="320" rx="14" fill="#0b0b0f" stroke="#27272a" />
            <text x="40" y="52" fill="#ffffff" font-size="18" font-family="Inter, sans-serif" font-weight="700">workmirror.exe（Windows 托盘常驻）</text>
            <text x="40" y="78" fill="#a1a1aa" font-size="12" font-family="Inter, sans-serif">单进程：采集 → 入库 → 会话/归因 → 本地 HTTP（API + SSE + UI 静态资源）</text>

            <rect x="40" y="110" width="240" height="90" rx="12" fill="#111113" stroke="#27272a" />
            <text x="56" y="140" fill="#e4e4e7" font-size="14" font-family="Inter, sans-serif" font-weight="600">Collectors</text>
            <text x="56" y="166" fill="#a1a1aa" font-size="12" font-family="Inter, sans-serif">Window / GitDiff / BrowserHistory</text>

            <rect x="300" y="110" width="220" height="90" rx="12" fill="#111113" stroke="#27272a" />
            <text x="316" y="140" fill="#e4e4e7" font-size="14" font-family="Inter, sans-serif" font-weight="600">SQLite（WAL）</text>
            <text x="316" y="166" fill="#a1a1aa" font-size="12" font-family="Inter, sans-serif">repository + schema_version 门闸</text>

            <rect x="40" y="220" width="240" height="90" rx="12" fill="#111113" stroke="#27272a" />
            <text x="56" y="250" fill="#e4e4e7" font-size="14" font-family="Inter, sans-serif" font-weight="600">Services</text>
            <text x="56" y="276" fill="#a1a1aa" font-size="12" font-family="Inter, sans-serif">会话切分 / Skill 归因 / 回顾生成</text>

            <rect x="300" y="220" width="220" height="90" rx="12" fill="#111113" stroke="#27272a" />
            <text x="316" y="250" fill="#e4e4e7" font-size="14" font-family="Inter, sans-serif" font-weight="600">Local HTTP</text>
            <text x="316" y="276" fill="#a1a1aa" font-size="12" font-family="Inter, sans-serif">JSON API + SSE + 静态 UI</text>

            <defs>
                <marker id="arrow" markerWidth="10" markerHeight="10" refX="7" refY="3" orient="auto">
                    <path d="M0,0 L0,6 L8,3 z" fill="#52525b"></path>
                </marker>
            </defs>

            <path d="M280 155 L300 155" stroke="#52525b" stroke-width="2" marker-end="url(#arrow)" />
            <path d="M160 220 L160 200" stroke="#52525b" stroke-width="2" marker-end="url(#arrow)" />
            <path d="M280 265 L300 265" stroke="#52525b" stroke-width="2" marker-end="url(#arrow)" />
            <path d="M410 200 L410 220" stroke="#52525b" stroke-width="2" marker-end="url(#arrow)" />

            <rect x="580" y="110" width="300" height="90" rx="12" fill="#0b0b0f" stroke="#27272a" />
            <text x="600" y="140" fill="#ffffff" font-size="14" font-family="Inter, sans-serif" font-weight="600">Browser / WebView（本地 UI）</text>
            <text x="600" y="166" fill="#a1a1aa" font-size="12" font-family="Inter, sans-serif">读取本地 API + SSE，展示 Dashboard/Sessions/Skills/Status</text>

            <path d="M520 265 L580 155" stroke="#52525b" stroke-width="2" marker-end="url(#arrow)" />

            <rect x="580" y="220" width="300" height="90" rx="12" fill="#0b0b0f" stroke="#27272a" stroke-dasharray="6 6" />
            <text x="600" y="250" fill="#e4e4e7" font-size="14" font-family="Inter, sans-serif" font-weight="600">UI 静态资源加载优先级</text>
            <text x="600" y="276" fill="#a1a1aa" font-size="12" font-family="Inter, sans-serif">同目录 frontend/dist/ → 内嵌 internal/uiassets</text>
            <path d="M520 290 L580 265" stroke="#52525b" stroke-width="2" marker-end="url(#arrow)" />
        </svg>
        <figcaption>图：单进程本地架构（仅监听 127.0.0.1），UI 与 API 同源服务。</figcaption>
    </figure>

    <h2>证据链流水线图（口径）</h2>
    <figure>
        <svg viewBox="0 0 900 300" width="100%" role="img" aria-label="复盘镜（WorkMirror）证据链流水线图">
            <defs>
                <marker id="arrow2" markerWidth="10" markerHeight="10" refX="7" refY="3" orient="auto">
                    <path d="M0,0 L0,6 L8,3 z" fill="#52525b"></path>
                </marker>
            </defs>

            <rect x="20" y="30" width="210" height="70" rx="12" fill="#111113" stroke="#27272a" />
            <text x="40" y="60" fill="#e4e4e7" font-size="14" font-family="Inter, sans-serif" font-weight="600">Raw Evidence</text>
            <text x="40" y="84" fill="#a1a1aa" font-size="12" font-family="Inter, sans-serif">WindowEvent / Diff / BrowserEvent</text>

            <rect x="260" y="30" width="200" height="70" rx="12" fill="#111113" stroke="#27272a" />
            <text x="280" y="60" fill="#e4e4e7" font-size="14" font-family="Inter, sans-serif" font-weight="600">会话切分（Sessionization）</text>
            <text x="280" y="84" fill="#a1a1aa" font-size="12" font-family="Inter, sans-serif">切分 + 聚合 + 覆盖率统计</text>

            <rect x="490" y="30" width="190" height="70" rx="12" fill="#111113" stroke="#27272a" />
            <text x="510" y="60" fill="#e4e4e7" font-size="14" font-family="Inter, sans-serif" font-weight="600">会话（权威口径）</text>
            <text x="510" y="84" fill="#a1a1aa" font-size="12" font-family="Inter, sans-serif">所有上层口径统一输入</text>

            <rect x="710" y="20" width="170" height="90" rx="12" fill="#0b0b0f" stroke="#27272a" />
            <text x="728" y="52" fill="#ffffff" font-size="14" font-family="Inter, sans-serif" font-weight="600">Outputs</text>
            <text x="728" y="76" fill="#a1a1aa" font-size="12" font-family="Inter, sans-serif">Skill / Daily / Weekly</text>
            <text x="728" y="98" fill="#a1a1aa" font-size="12" font-family="Inter, sans-serif">可点开证据链</text>

            <path d="M230 65 L260 65" stroke="#52525b" stroke-width="2" marker-end="url(#arrow2)" />
            <path d="M460 65 L490 65" stroke="#52525b" stroke-width="2" marker-end="url(#arrow2)" />
            <path d="M680 65 L710 65" stroke="#52525b" stroke-width="2" marker-end="url(#arrow2)" />

            <rect x="260" y="150" width="200" height="60" rx="12" fill="#0b0b0f" stroke="#27272a" />
            <text x="280" y="178" fill="#e4e4e7" font-size="13" font-family="Inter, sans-serif" font-weight="600">离线规则口径</text>
            <text x="280" y="200" fill="#a1a1aa" font-size="12" font-family="Inter, sans-serif">不依赖外部 AI</text>

            <rect x="490" y="150" width="200" height="60" rx="12" fill="#0b0b0f" stroke="#27272a" />
            <text x="510" y="178" fill="#e4e4e7" font-size="13" font-family="Inter, sans-serif" font-weight="600">AI 增强（可选）</text>
            <text x="510" y="200" fill="#a1a1aa" font-size="12" font-family="Inter, sans-serif">语义摘要/标签/建议（脱敏后）</text>

            <path d="M360 100 L360 150" stroke="#52525b" stroke-width="2" marker-end="url(#arrow2)" />
            <path d="M590 100 L590 150" stroke="#52525b" stroke-width="2" marker-end="url(#arrow2)" />
            <path d="M460 180 L490 180" stroke="#52525b" stroke-width="2" marker-end="url(#arrow2)" />

            <rect x="20" y="150" width="210" height="120" rx="12" fill="#0b0b0f" stroke="#27272a" stroke-dasharray="6 6" />
            <text x="40" y="178" fill="#e4e4e7" font-size="13" font-family="Inter, sans-serif" font-weight="600">可观测性 / 诊断</text>
            <text x="40" y="204" fill="#a1a1aa" font-size="12" font-family="Inter, sans-serif">/api/status</text>
            <text x="40" y="228" fill="#a1a1aa" font-size="12" font-family="Inter, sans-serif">/api/diagnostics/export</text>
            <text x="40" y="252" fill="#a1a1aa" font-size="12" font-family="Inter, sans-serif">重建会话 / 补全语义</text>
            <path d="M125 100 L125 150" stroke="#52525b" stroke-width="2" marker-end="url(#arrow2)" />
        </svg>
        <figcaption>图：会话为权威输入；离线规则可用，AI 作为可选增强；失败路径通过状态与诊断动作显式暴露。</figcaption>
    </figure>

    <details>
        <summary>开发者：目录结构（Go / React）</summary>
        <ul>
            <li><code>cmd/workmirror-agent/</code>：Windows Agent 入口（托盘、采集器、HTTP API/UI）</li>
            <li><code>internal/collector/</code>：采集器（窗口/Diff/浏览历史）</li>
            <li><code>internal/server/</code>：本地 HTTP Server（JSON API + SSE + 静态 UI）</li>
            <li><code>internal/service/</code>：Session/Skill/回顾等业务逻辑</li>
            <li><code>internal/repository/</code>：SQLite 数据访问与迁移门闸（<code>schema_version</code>）</li>
            <li><code>frontend/</code>：前端源码（开发时通过 <code>VITE_API_TARGET</code> 指向本地 Agent）</li>
        </ul>
    </details>

    <h2>口径说明</h2>
    <p>上层的技能/回顾不直接从 raw 统计，而是统一以会话为输入，保证"同一套数字、同一条证据链"。</p>

    <h2>出了问题怎么自助排查</h2>
    <p>当数据为空/不可信时，优先从状态页定位缺口（采集/切分/分析/配置），并按提示执行：补配 watch paths、重建某天会话、导出诊断包等。</p>
</article>
